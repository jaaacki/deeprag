<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emby Processor Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; }
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-value { font-size: 2.5rem; font-weight: bold; }
        .stat-label { color: #6c757d; text-transform: uppercase; font-size: 0.875rem; }
        .status-badge { font-size: 0.75rem; padding: 0.25rem 0.5rem; }
        .log-viewer { background: #212529; color: #f8f9fa; font-family: 'Courier New', monospace; font-size: 0.875rem; height: 600px; overflow-y: auto; padding: 1rem; border-radius: 0.375rem; white-space: pre-wrap; word-break: break-all; }
        .queue-table { font-size: 0.875rem; }
        .action-btn { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
        #refreshIndicator { display: none; }
        #refreshIndicator.active { display: inline-block; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1090; }
        .btn-loading .spinner-border { width: 0.875rem; height: 0.875rem; border-width: 0.15em; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h1><i class="bi bi-hdd-network"></i> Emby Processor Dashboard</h1>
                <p class="text-muted">Real-time queue monitoring and control panel
                    <span id="refreshIndicator" class="spinner-border spinner-border-sm ms-2"></span>
                    <span id="lastUpdate" class="ms-2 text-muted"></span>
                </p>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4" id="statsCards">
            <div class="col-md-2">
                <div class="card stat-card border-primary">
                    <div class="card-body text-center">
                        <div class="stat-value text-primary" id="stat-total">-</div>
                        <div class="stat-label">Total</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card border-success">
                    <div class="card-body text-center">
                        <div class="stat-value text-success" id="stat-completed">-</div>
                        <div class="stat-label">Completed</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card border-warning">
                    <div class="card-body text-center">
                        <div class="stat-value text-warning" id="stat-pending">-</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card border-info">
                    <div class="card-body text-center">
                        <div class="stat-value text-info" id="stat-processing">-</div>
                        <div class="stat-label">Processing</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card border-danger">
                    <div class="card-body text-center">
                        <div class="stat-value text-danger" id="stat-error">-</div>
                        <div class="stat-label">Errors</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card border-secondary">
                    <div class="card-body text-center">
                        <div class="stat-value text-secondary" id="stat-moved">-</div>
                        <div class="stat-label">Moved</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Actions -->
        <div class="row mb-3">
            <div class="col-md-3">
                <select class="form-select" id="filterStatus">
                    <option value="">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="processing">Processing</option>
                    <option value="moved">Moved</option>
                    <option value="emby_pending">Emby Pending</option>
                    <option value="completed">Completed</option>
                    <option value="error">Error</option>
                </select>
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control" id="searchQuery" placeholder="Search movie code or actress">
            </div>
            <div class="col-md-6 text-end">
                <div class="form-check form-check-inline me-3">
                    <input class="form-check-input" type="checkbox" id="forceFreshMetadata" onchange="saveForceFreshSetting()">
                    <label class="form-check-label" for="forceFreshMetadata" title="Bypass cache and fetch fresh metadata from API">
                        <i class="bi bi-lightning-charge"></i> Force Fresh
                    </label>
                </div>
                <button class="btn btn-outline-primary" onclick="refreshData()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                <button class="btn btn-outline-secondary" onclick="toggleLogs()" id="toggleLogsBtn">
                    <i class="bi bi-terminal"></i> Hide Logs
                </button>
                <button class="btn btn-outline-info" onclick="bulkRefreshMetadata()">
                    <i class="bi bi-cloud-download"></i> Bulk Refresh Metadata
                </button>
                <button class="btn btn-outline-danger" onclick="triggerCleanup()">
                    <i class="bi bi-trash"></i> Cleanup Old Items
                </button>
            </div>
        </div>

        <!-- Download Form -->
        <div class="row mb-4">
            <div class="col">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-download"></i> yt-dlp Download</h5>
                    </div>
                    <div class="card-body">
                        <form id="downloadForm" onsubmit="submitDownload(event)">
                            <div class="row g-2 align-items-end">
                                <div class="col-md-6">
                                    <label for="downloadUrl" class="form-label">URL</label>
                                    <input type="url" class="form-control" id="downloadUrl" placeholder="https://..." required>
                                </div>
                                <div class="col-md-4">
                                    <label for="downloadFilename" class="form-label">Filename <small class="text-muted">(optional)</small></label>
                                    <input type="text" class="form-control" id="downloadFilename" placeholder="custom-filename">
                                </div>
                                <div class="col-md-2">
                                    <button type="submit" class="btn btn-primary w-100" id="downloadBtn">
                                        <i class="bi bi-download"></i> Download
                                    </button>
                                </div>
                            </div>
                        </form>
                        <!-- Recent Downloads -->
                        <div id="recentDownloads" class="mt-3" style="display: none;">
                            <h6 class="text-muted mb-2">Recent Downloads</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered mb-0" style="font-size: 0.8rem;">
                                    <thead class="table-light">
                                        <tr>
                                            <th>ID</th>
                                            <th>URL</th>
                                            <th>Filename</th>
                                            <th>Status</th>
                                            <th>Started</th>
                                        </tr>
                                    </thead>
                                    <tbody id="downloadsTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Queue Table -->
        <div class="row mb-4">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-list-ul"></i> Queue Items (<span id="queueCount">0</span>)</h5>
                    </div>
                    <div class="card-body p-0" style="overflow: visible;">
                        <table class="table table-hover queue-table mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Movie Code</th>
                                    <th>Actress</th>
                                    <th>Status</th>
                                    <th>Emby ID</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="queueTableBody">
                                <tr><td colspan="7" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Section (Visible by Default) -->
        <div class="row mb-4" id="logsSection" style="display: block;">
            <div class="col">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-terminal-fill"></i> Live Logs</h5>
                        <button class="btn btn-sm btn-outline-light" onclick="refreshLogs()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="log-viewer" id="logViewer">Loading logs...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Item Detail Modal -->
    <div class="modal fade" id="itemDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Item Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="itemDetailBody">
                    Loading...
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let autoRefreshInterval;
        let logsRefreshInterval;
        const API_BASE = '';
        let embyPublicUrl = '';
        let embyServerId = '';

        // Load config (Emby URL, server ID)
        async function loadConfig() {
            try {
                const res = await fetch(`${API_BASE}/api/config`);
                const data = await res.json();
                embyPublicUrl = (data.emby_public_url || '').replace(/\/+$/, '');
                embyServerId = data.emby_server_id || '';
            } catch (e) {
                console.warn('Failed to load config:', e);
            }
        }

        function getEmbyItemUrl(embyItemId) {
            if (!embyPublicUrl || !embyItemId) return '';
            let url = `${embyPublicUrl}/web/index.html#!/item?id=${embyItemId}`;
            if (embyServerId) url += `&serverId=${embyServerId}`;
            return url;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            await loadConfig();
            refreshData();
            startAutoRefresh();

            // Load force fresh setting from localStorage
            const forceFresh = localStorage.getItem('forceFreshMetadata') === 'true';
            document.getElementById('forceFreshMetadata').checked = forceFresh;

            // Start logs auto-refresh since logs are visible by default
            refreshLogs();
            startLogsAutoRefresh();

            // Event listeners
            document.getElementById('filterStatus').addEventListener('change', refreshQueue);
            document.getElementById('searchQuery').addEventListener('input', debounce(refreshQueue, 500));
        });

        // Save force fresh setting to localStorage
        function saveForceFreshSetting() {
            const forceFresh = document.getElementById('forceFreshMetadata').checked;
            localStorage.setItem('forceFreshMetadata', forceFresh);
            if (forceFresh) {
                showToast('Force Fresh enabled - bypassing cache', 'info');
            } else {
                showToast('Force Fresh disabled - using cached data', 'info');
            }
        }

        // Get current force fresh setting
        function getForceFresh() {
            return document.getElementById('forceFreshMetadata').checked;
        }

        // Auto-refresh every 5 seconds
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(refreshData, 5000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        }

        // Auto-refresh logs every 2 seconds when visible
        function startLogsAutoRefresh() {
            if (!logsRefreshInterval) {
                logsRefreshInterval = setInterval(refreshLogs, 2000);
            }
        }

        function stopLogsAutoRefresh() {
            if (logsRefreshInterval) {
                clearInterval(logsRefreshInterval);
                logsRefreshInterval = null;
            }
        }

        // Check if any dropdown is currently open
        function isAnyDropdownOpen() {
            const dropdowns = document.querySelectorAll('.dropdown-menu.show');
            return dropdowns.length > 0;
        }

        // Refresh all data (skip if dropdown is open to avoid destroying it)
        async function refreshData() {
            // Don't refresh if user has a dropdown open
            if (isAnyDropdownOpen()) {
                console.log('Skipping refresh - dropdown is open');
                return;
            }

            showRefreshIndicator();
            await Promise.all([refreshStats(), refreshQueue(), refreshDownloads()]);
            hideRefreshIndicator();
            updateLastUpdateTime();
        }

        // Fetch and update stats
        async function refreshStats() {
            try {
                const response = await fetch(`${API_BASE}/api/stats`);
                const data = await response.json();

                document.getElementById('stat-total').textContent = data.total || 0;
                document.getElementById('stat-completed').textContent = data.completed || 0;
                document.getElementById('stat-pending').textContent = data.pending || 0;
                document.getElementById('stat-processing').textContent = data.processing || 0;
                document.getElementById('stat-error').textContent = data.error || 0;
                document.getElementById('stat-moved').textContent = data.moved || 0;
            } catch (error) {
                console.error('Failed to fetch stats:', error);
            }
        }

        // Fetch and update queue table
        async function refreshQueue() {
            const status = document.getElementById('filterStatus').value;
            const search = document.getElementById('searchQuery').value;

            const params = new URLSearchParams();
            if (status) params.append('status', status);
            if (search) params.append('search', search);
            params.append('limit', '50');

            try {
                const response = await fetch(`${API_BASE}/api/queue?${params}`);
                const data = await response.json();

                document.getElementById('queueCount').textContent = data.total;

                const tbody = document.getElementById('queueTableBody');
                if (data.items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No items found</td></tr>';
                    return;
                }

                tbody.innerHTML = data.items.map(item => `
                    <tr>
                        <td><code>${item.id}</code></td>
                        <td><strong>${item.movie_code || '-'}</strong></td>
                        <td>${item.actress || '-'}</td>
                        <td>${getStatusBadge(item.status)}</td>
                        <td>${item.emby_item_id ? `<code>${item.emby_item_id}</code>` : '-'}</td>
                        <td><small>${formatDate(item.created_at)}</small></td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-info action-btn" onclick="viewDetails(${item.id})" title="View Details">
                                    <i class="bi bi-eye"></i>
                                </button>
                                ${item.emby_item_id && embyPublicUrl ? `<a class="btn btn-sm btn-outline-success action-btn" href="${getEmbyItemUrl(item.emby_item_id)}" target="_blank" title="Open in Emby">
                                    <i class="bi bi-tv"></i>
                                </a>` : ''}
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" data-bs-auto-close="true" title="Actions">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><h6 class="dropdown-header">Pipeline Steps</h6></li>
                                        <li><a class="dropdown-item" href="#" onclick="runAction(${item.id}, 'extract-code', event)">
                                            <i class="bi bi-search"></i> Re-extract Code
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="runAction(${item.id}, 'fetch-metadata', event)">
                                            <i class="bi bi-cloud-download"></i> Re-fetch Metadata
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="runAction(${item.id}, 'rename-file', event)">
                                            <i class="bi bi-file-earmark-arrow-up"></i> Re-rename & Move
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="runAction(${item.id}, 'update-emby', event)">
                                            <i class="bi bi-tv"></i> Re-update Emby
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-warning" href="#" onclick="runAction(${item.id}, 'full-retry', event)">
                                            <i class="bi bi-arrow-clockwise"></i> Full Retry
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteItem(${item.id}, event)">
                                            <i class="bi bi-trash"></i> Delete from Queue
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to fetch queue:', error);
                document.getElementById('queueTableBody').innerHTML =
                    '<tr><td colspan="7" class="text-center text-danger">Error loading queue</td></tr>';
            }
        }

        // View item details
        async function viewDetails(itemId) {
            const modal = new bootstrap.Modal(document.getElementById('itemDetailModal'));
            const body = document.getElementById('itemDetailBody');

            body.innerHTML = 'Loading...';
            modal.show();

            try {
                const response = await fetch(`${API_BASE}/api/queue/${itemId}`);
                const item = await response.json();

                body.innerHTML = `
                    <dl class="row">
                        <dt class="col-sm-3">ID</dt>
                        <dd class="col-sm-9"><code>${item.id}</code></dd>

                        <dt class="col-sm-3">Movie Code</dt>
                        <dd class="col-sm-9"><strong>${item.movie_code || '-'}</strong></dd>

                        <dt class="col-sm-3">Actress</dt>
                        <dd class="col-sm-9">${item.actress || '-'}</dd>

                        <dt class="col-sm-3">Subtitle</dt>
                        <dd class="col-sm-9">${item.subtitle || '-'}</dd>

                        <dt class="col-sm-3">Status</dt>
                        <dd class="col-sm-9">${getStatusBadge(item.status)}</dd>

                        <dt class="col-sm-3">Original Path</dt>
                        <dd class="col-sm-9"><code class="small">${item.file_path}</code></dd>

                        <dt class="col-sm-3">New Path</dt>
                        <dd class="col-sm-9"><code class="small">${item.new_path || '-'}</code></dd>

                        <dt class="col-sm-3">Emby Item ID</dt>
                        <dd class="col-sm-9"><code>${item.emby_item_id || '-'}</code></dd>

                        <dt class="col-sm-3">Retry Count</dt>
                        <dd class="col-sm-9">${item.retry_count} / 4</dd>

                        ${item.error_message ? `
                            <dt class="col-sm-3">Error</dt>
                            <dd class="col-sm-9"><span class="text-danger">${item.error_message}</span></dd>
                        ` : ''}

                        <dt class="col-sm-3">Created</dt>
                        <dd class="col-sm-9">${formatDate(item.created_at)}</dd>

                        <dt class="col-sm-3">Updated</dt>
                        <dd class="col-sm-9">${formatDate(item.updated_at)}</dd>

                        ${item.metadata_json ? `
                            <dt class="col-sm-3">Metadata</dt>
                            <dd class="col-sm-9">
                                <pre class="bg-light p-2 rounded" style="max-height: 300px; overflow-y: auto; font-size: 0.75rem;">${JSON.stringify(item.metadata_json, null, 2)}</pre>
                            </dd>
                        ` : ''}
                    </dl>
                `;
            } catch (error) {
                body.innerHTML = `<div class="alert alert-danger">Error loading item details: ${error.message}</div>`;
            }
        }

        // Retry failed item (deprecated - use runAction instead)
        async function retryItem(itemId) {
            return runAction(itemId, 'full-retry', null);
        }

        // Reprocess metadata (deprecated - use runAction instead)
        async function reprocessMetadata(itemId) {
            return runAction(itemId, 'update-emby', null);
        }

        // Bulk refresh metadata for all completed items
        async function bulkRefreshMetadata() {
            const forceFresh = getForceFresh();
            const freshText = forceFresh ? '\n• FORCE FRESH enabled - bypassing cache' : '';

            const updateEmby = confirm(
                'Refresh metadata for all completed items using NEW unified search?\n\n' +
                'This will:\n' +
                '• Re-fetch metadata from WordPress (unified /emby/v1/search)\n' +
                '• NOT move files - only update metadata\n' +
                '• Update Emby with new metadata (if you click OK)' +
                freshText + '\n\n' +
                'Click OK to update Emby, Cancel to skip Emby update'
            );

            if (updateEmby === null) return; // User cancelled the first dialog

            const confirmText = updateEmby
                ? 'Refresh metadata AND update Emby for all completed items?'
                : 'Refresh metadata (skip Emby update) for all completed items?';

            if (!confirm(confirmText)) {
                showToast('Bulk refresh cancelled', 'info');
                return;
            }

            const freshMsg = forceFresh ? ' (FORCE FRESH)' : '';
            showToast(`Starting bulk metadata refresh${freshMsg}... (check logs)`, 'info');

            try {
                const response = await fetch(
                    `${API_BASE}/api/bulk/refresh-metadata?status=completed&update_emby=${updateEmby}&fresh=${forceFresh}`,
                    { method: 'POST' }
                );

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Bulk refresh failed');
                }

                const result = await response.json();

                if (result.failed > 0) {
                    showToast(
                        `Refreshed ${result.updated}/${result.total} items (${result.failed} failed - check logs)`,
                        'warning'
                    );
                } else {
                    showToast(
                        `Successfully refreshed ${result.updated}/${result.total} items`,
                        'success'
                    );
                }

                setTimeout(() => refreshData(), 1000);
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }

        // Cleanup old items
        async function triggerCleanup() {
            const days = prompt('Delete completed items older than how many days?', '30');
            if (!days || isNaN(days)) {
                showToast('Cleanup cancelled', 'info');
                return;
            }

            if (!confirm(`Delete all completed items older than ${days} days?`)) {
                showToast('Cleanup cancelled', 'info');
                return;
            }

            showToast('Deleting old items...', 'info');

            try {
                const response = await fetch(`${API_BASE}/api/cleanup?older_than_days=${days}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('Cleanup failed');
                }

                const result = await response.json();
                showToast(`Deleted ${result.deleted_count} items`, 'success');
                setTimeout(() => refreshData(), 500);
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }

        // Toggle logs section
        function toggleLogs() {
            const section = document.getElementById('logsSection');
            const btn = document.getElementById('toggleLogsBtn');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                btn.innerHTML = '<i class="bi bi-terminal"></i> Hide Logs';
                refreshLogs();
                startLogsAutoRefresh(); // Auto-refresh logs every 2 seconds
            } else {
                section.style.display = 'none';
                btn.innerHTML = '<i class="bi bi-terminal"></i> Show Logs';
                stopLogsAutoRefresh(); // Stop refreshing when hidden
            }
        }

        // Refresh logs
        async function refreshLogs() {
            try {
                const response = await fetch(`${API_BASE}/api/logs?lines=200`);
                const data = await response.json();

                const viewer = document.getElementById('logViewer');
                const wasAtBottom = viewer.scrollHeight - viewer.scrollTop <= viewer.clientHeight + 50;

                if (data.lines && data.lines.length > 0) {
                    viewer.innerHTML = data.lines.map(line =>
                        `<div>${escapeHtml(line)}</div>`
                    ).join('');
                } else {
                    viewer.innerHTML = '<div class="text-muted">No logs yet. Logs will appear here as actions are performed.</div>';
                }

                // Auto-scroll to bottom if was already at bottom or if first load
                if (wasAtBottom || viewer.scrollTop === 0) {
                    viewer.scrollTop = viewer.scrollHeight;
                }
            } catch (error) {
                document.getElementById('logViewer').innerHTML = `<div class="text-danger">Error loading logs: ${error.message}</div>`;
            }
        }

        // Toast notifications - STAY VISIBLE until user closes them
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = `toast-${Date.now()}`;

            const bgColors = {
                'success': 'bg-success',
                'error': 'bg-danger',
                'warning': 'bg-warning',
                'info': 'bg-info'
            };

            const icons = {
                'success': 'bi-check-circle',
                'error': 'bi-x-circle',
                'warning': 'bi-exclamation-triangle',
                'info': 'bi-info-circle'
            };

            const toastHTML = `
                <div id="${toastId}" class="toast align-items-center text-white ${bgColors[type] || 'bg-info'} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi ${icons[type] || 'bi-info-circle'} me-2"></i>
                            ${escapeHtml(message)}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;

            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            const toastElement = document.getElementById(toastId);

            // autohide: false - toasts stay until user clicks X
            const toast = new bootstrap.Toast(toastElement, { autohide: false });
            toast.show();

            // Remove from DOM after user closes it
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        // Delete item from queue
        async function deleteItem(itemId, event) {
            if (event) event.preventDefault();

            if (!confirm(`Delete item ${itemId} from queue?\n\nThis will remove it from the processing queue.\nThe actual file will NOT be deleted.`)) {
                showToast('Delete cancelled', 'info');
                return;
            }

            showToast('Deleting item...', 'info');

            try {
                const response = await fetch(`${API_BASE}/api/queue/${itemId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Delete failed');
                }

                const result = await response.json();

                if (result.success) {
                    showToast(result.message || 'Item deleted successfully', 'success');
                    // Force refresh to remove deleted item from table
                    setTimeout(() => refreshData(), 500);
                } else {
                    showToast(result.message || 'Delete failed', 'error');
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }

        // Run granular action with loading state
        async function runAction(itemId, action, event) {
            if (event) event.preventDefault();

            const actionNames = {
                'extract-code': 'Re-extracting code',
                'fetch-metadata': 'Re-fetching metadata',
                'rename-file': 'Re-renaming & moving file',
                'update-emby': 'Re-updating Emby',
                'full-retry': 'Resetting for full retry'
            };

            const loadingMsg = actionNames[action] || 'Processing';
            const forceFresh = getForceFresh();

            if (forceFresh && (action === 'fetch-metadata' || action === 'update-emby')) {
                showToast(`${loadingMsg} (FORCE FRESH - bypassing cache)...`, 'info');
            } else {
                showToast(`${loadingMsg}...`, 'info');
            }

            try {
                // Add fresh parameter for metadata actions if force fresh is enabled
                const url = new URL(`${API_BASE}/api/queue/${itemId}/actions/${action}`, window.location.origin);
                if (forceFresh && (action === 'fetch-metadata' || action === 'update-emby')) {
                    url.searchParams.append('fresh', 'true');
                }

                const response = await fetch(url, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Action failed');
                }

                const result = await response.json();

                if (result.success) {
                    showToast(result.message || 'Action completed successfully', 'success');
                    // Don't auto-refresh - let user keep dropdown open for multiple actions
                    // The 5-second auto-refresh will update the table
                } else {
                    showToast(result.message || 'Action failed', 'error');
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }

        // === Download Form ===
        async function submitDownload(event) {
            event.preventDefault();
            const urlInput = document.getElementById('downloadUrl');
            const filenameInput = document.getElementById('downloadFilename');
            const btn = document.getElementById('downloadBtn');

            const url = urlInput.value.trim();
            if (!url) return;

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Starting...';

            try {
                const params = new URLSearchParams({ url });
                if (filenameInput.value.trim()) {
                    params.append('filename', filenameInput.value.trim());
                }

                const response = await fetch(`${API_BASE}/api/download?${params}`, { method: 'POST' });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Download failed');
                }

                const result = await response.json();
                showToast(result.message || 'Download started', 'success');
                urlInput.value = '';
                filenameInput.value = '';
                refreshDownloads();
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-download"></i> Download';
            }
        }

        async function refreshDownloads() {
            try {
                const response = await fetch(`${API_BASE}/api/downloads?limit=10`);
                const data = await response.json();

                const container = document.getElementById('recentDownloads');
                const tbody = document.getElementById('downloadsTableBody');

                if (!data.jobs || data.jobs.length === 0) {
                    container.style.display = 'none';
                    return;
                }

                container.style.display = 'block';
                tbody.innerHTML = data.jobs.map(job => `
                    <tr>
                        <td><code>${job.id}</code></td>
                        <td class="text-truncate" style="max-width: 300px;" title="${escapeHtml(job.url)}">${escapeHtml(job.url)}</td>
                        <td>${job.filename ? escapeHtml(job.filename) : '<span class="text-muted">auto</span>'}</td>
                        <td>${getDownloadStatusBadge(job.status)}</td>
                        <td><small>${job.started_at ? formatDate(job.started_at) : '-'}</small></td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to fetch downloads:', error);
            }
        }

        function getDownloadStatusBadge(status) {
            const map = {
                'queued': '<span class="badge bg-secondary">queued</span>',
                'downloading': '<span class="badge bg-primary"><span class="spinner-border spinner-border-sm" style="width:0.6rem;height:0.6rem;"></span> downloading</span>',
                'completed': '<span class="badge bg-success">completed</span>',
                'failed': '<span class="badge bg-danger">failed</span>',
            };
            return map[status] || `<span class="badge bg-secondary">${status}</span>`;
        }

        // Helper functions
        function getStatusBadge(status) {
            const badges = {
                'pending': 'warning',
                'processing': 'info',
                'moved': 'secondary',
                'emby_pending': 'secondary',
                'completed': 'success',
                'error': 'danger'
            };
            return `<span class="badge bg-${badges[status] || 'secondary'} status-badge">${status}</span>`;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showRefreshIndicator() {
            document.getElementById('refreshIndicator').classList.add('active');
        }

        function hideRefreshIndicator() {
            document.getElementById('refreshIndicator').classList.remove('active');
        }

        function updateLastUpdateTime() {
            document.getElementById('lastUpdate').textContent =
                `Last updated: ${new Date().toLocaleTimeString()}`;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>
